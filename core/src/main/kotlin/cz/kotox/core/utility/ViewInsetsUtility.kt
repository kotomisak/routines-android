package cz.kotox.core.utility

import android.view.View
import android.view.WindowInsets
import androidx.databinding.BindingAdapter

private class InitialPadding(val left: Int, val top: Int, val right: Int, val bottom: Int)

/**
 * Correctly apply view window insets when drawing behind window elements
 *
 * @see https://medium.com/androiddevelopers/windowinsets-listeners-to-layouts-8f9ccc8fa4d1
 */
private fun View.doOnApplyWindowInsets(action: (View, WindowInsets, InitialPadding) -> Unit) {
	// Create a snapshot of the view's padding state
	val initialPadding = recordInitialPaddingForView(this)
	// Set an actual OnApplyWindowInsetsListener which proxies to the given
	// lambda, also passing in the original padding state
	setOnApplyWindowInsetsListener { v, insets ->
		action(v, insets, initialPadding)
		// Always return the insets, so that children can also use them
		insets
	}
	// request some insets
	requestApplyInsetsWhenAttached()
}

private fun recordInitialPaddingForView(view: View) = InitialPadding(view.paddingLeft, view.paddingTop, view.paddingRight, view.paddingBottom)

private fun View.requestApplyInsetsWhenAttached() {
	if (isAttachedToWindow) {
		// We're already attached, just request as normal
		requestApplyInsets()
	} else {
		// We're not attached to the hierarchy, add a listener to
		// request when we are
		addOnAttachStateChangeListener(object : View.OnAttachStateChangeListener {
			override fun onViewAttachedToWindow(v: View) {
				v.removeOnAttachStateChangeListener(this)
				v.requestApplyInsets()
			}

			override fun onViewDetachedFromWindow(v: View) = Unit
		})
	}
}

@BindingAdapter(
	"paddingLeftSystemWindowInsets",
	"paddingTopSystemWindowInsets",
	"paddingRightSystemWindowInsets",
	"paddingBottomSystemWindowInsets",
	requireAll = false
)
fun applySystemWindows(
	view: View,
	applyLeft: Boolean,
	applyTop: Boolean,
	applyRight: Boolean,
	applyBottom: Boolean
) {
	view.doOnApplyWindowInsets { view, insets, padding ->
		val left = if (applyLeft) insets.systemWindowInsetLeft else 0
		val top = if (applyTop) insets.systemWindowInsetTop else 0
		val right = if (applyRight) insets.systemWindowInsetRight else 0
		val bottom = if (applyBottom) insets.systemWindowInsetBottom else 0

		view.setPadding(
			padding.left + left,
			padding.top + top,
			padding.right + right,
			padding.bottom + bottom
		)
	}
}
